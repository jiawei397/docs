(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{447:function(e,v,_){"use strict";_.r(v);var r=_(25),t=Object(r.a)({},(function(){var e=this,v=e.$createElement,_=e._self._c||v;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("h1",{attrs:{id:"什么情况下vue使用index作为key会出问题-转"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#什么情况下vue使用index作为key会出问题-转"}},[e._v("#")]),e._v(" 什么情况下Vue使用index作为key会出问题（转）")]),e._v(" "),_("p",[e._v("先说结论：")]),e._v(" "),_("p",[e._v("在使用非文本节点的组件，且这个组件没有依赖于响应式的"),_("code",[e._v("props")]),e._v("，此时使用"),_("code",[e._v("index")]),e._v("作为"),_("code",[e._v("key")]),e._v("，那么此时对于列表的删除操作会导致视图错乱。")]),e._v(" "),_("h2",{attrs:{id:"背景"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[e._v("#")]),e._v(" 背景")]),e._v(" "),_("p",[e._v("在动态删除"),_("code",[e._v("v-for")]),e._v("渲染的列表的过程中，如果"),_("code",[e._v("key")]),e._v("指定为"),_("code",[e._v("index")]),e._v("，则可能出现渲染错乱的问题。比如，你的列表有两行，你明明删了第一行，结果却是第二行消失了。")]),e._v(" "),_("h2",{attrs:{id:"解析"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#解析"}},[e._v("#")]),e._v(" 解析")]),e._v(" "),_("p",[e._v("问题源于"),_("code",[e._v("key")]),e._v("的重复，假设你的列表有两行，当你删了第一行，那么第二行的"),_("code",[e._v("key")]),e._v("就变成了第一行的"),_("code",[e._v("key")]),e._v("，这两个"),_("code",[e._v("key")]),e._v("是相同的。基于"),_("code",[e._v("VirtualDOM")]),e._v("的库会把"),_("code",[e._v("key")]),e._v("相同的组件认作同一个组件，因而不会去更新视图。")]),e._v(" "),_("p",[e._v("也就是说，你删了第一行，本来预期的第二行变成了第一行，结果变成因为"),_("code",[e._v("key")]),e._v("相同，最后第一行保持不变，反而是第二行消失了。")]),e._v(" "),_("p",[e._v("其实在测试样例中可以看到，每次删除的都是最后一行，因为不管你想要删除哪一条，改变后的"),_("code",[e._v("data")]),e._v("的索引必然是少了最后一个，所以最后一行总是被牺牲的那个。")]),e._v(" "),_("h2",{attrs:{id:"为什么我没有复现"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#为什么我没有复现"}},[e._v("#")]),e._v(" 为什么我没有复现")]),e._v(" "),_("p",[e._v("大部分时候我们即使使用"),_("code",[e._v("index")]),e._v("作为"),_("code",[e._v("key")]),e._v("，不会复现这个问题，这好像与我们上述分析不符。但是事实上，“使用index作为key并且不会出问题”这种场景，其实过程是这样的：")]),e._v(" "),_("p",[e._v("第一步：通过修改数据删除第一行，数据变化引起"),_("code",[e._v("vue")]),e._v("去更新视图，更新的过程中发现"),_("code",[e._v("key")]),e._v("相同，最终第一行保持不变，反而是第二行消失。这是第一次"),_("code",[e._v("render")]),e._v("。")]),e._v(" "),_("p",[e._v("第二步：第一行的"),_("code",[e._v("VirtualDOM")]),e._v("的确没有变，但是第一行的组件的"),_("code",[e._v("props")]),e._v("变了，由原来第一行的"),_("code",[e._v("props")]),e._v("，变成了第二行的"),_("code",[e._v("props")]),e._v("，由于"),_("code",[e._v("props")]),e._v("变化，第一行的组件需要使用新的"),_("code",[e._v("props")]),e._v("更新视图，最终第一行变成了第二行的样子。这是第二次"),_("code",[e._v("render")]),e._v("。")]),e._v(" "),_("p",[e._v("也就是说，“使用index作为key并且不会出问题”这种场景，是因为"),_("code",[e._v("render")]),e._v("了两次，才最终达成了视图的正确更新。")]),e._v(" "),_("h2",{attrs:{id:"什么时候可以复现"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#什么时候可以复现"}},[e._v("#")]),e._v(" 什么时候可以复现")]),e._v(" "),_("p",[e._v("如果你去删除第一行的过程中，只会触发一次"),_("code",[e._v("render")]),e._v("，那么就会复现问题。也就是说，如果每一行的组件，不依赖于任何“响应式”数据，那么就不会有第二次"),_("code",[e._v("render")]),e._v("，问题就能复现！")]),e._v(" "),_("p",[e._v("用"),_("code",[e._v("vue2")]),e._v("和"),_("code",[e._v("vue3")]),e._v("都测试，一样的，虽然没有用"),_("code",[e._v("React")]),e._v("测试，结果应该也是一样的。代码可以见"),_("a",{attrs:{href:"https://gitee.com/JiQingYun/vite-demo/tree/develop/",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),_("OutboundLink")],1)]),e._v(" "),_("h2",{attrs:{id:"特殊情况"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#特殊情况"}},[e._v("#")]),e._v(" 特殊情况")]),e._v(" "),_("p",[e._v("如果列表中的组件，是简单的文本节点，文本节点没有"),_("code",[e._v("props")]),e._v("，那么它会不会复现问题呢？")]),e._v(" "),_("p",[e._v("答案是“不会”，"),_("code",[e._v("Vue")]),e._v("的"),_("code",[e._v("Diff")]),e._v("过程对文本节点有特殊处理，不管"),_("code",[e._v("key")]),e._v("一不一样，都会用“新的文本节点”覆盖“旧的文本节点”。")]),e._v(" "),_("h2",{attrs:{id:"结论"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[e._v("#")]),e._v(" 结论")]),e._v(" "),_("p",[e._v("在使用非文本节点的组件，且这个组件没有依赖于响应式的props，那么此时对于列表的删除操作会导致视图错乱。")]),e._v(" "),_("blockquote",[_("p",[e._v("本文转自"),_("a",{attrs:{href:"https://www.cnblogs.com/eret9616/p/13642900.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),_("OutboundLink")],1)])])])}),[],!1,null,null,null);v.default=t.exports}}]);