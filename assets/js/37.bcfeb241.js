(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{402:function(t,s,n){"use strict";n.r(s);var a=n(25),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"记一次并发请求报错"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#记一次并发请求报错"}},[t._v("#")]),t._v(" 记一次并发请求报错")]),t._v(" "),n("p",[t._v("背景是要做一个类似爬虫的功能，从第3方网站下载资源。首先有个函数判断是否url地址有效，所以需要请求一遍。\n本地测试没有问题，但上线后，概率性地出现一个错误：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("write: connection reset by peer\n")])])]),n("p",[t._v("上网一查，这错还是比较常见的，加上关键字"),n("code",[t._v("go")]),t._v("搜索下，也有不少。")]),t._v(" "),n("h2",{attrs:{id:"close大法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#close大法"}},[t._v("#")]),t._v(" close大法")]),t._v(" "),n("p",[t._v("首先看的是这篇"),n("a",{attrs:{href:"https://studygolang.com/articles/9190",target:"_blank",rel:"noopener noreferrer"}},[t._v('Go 解决"Connection reset by peer"或"EOF"问题'),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("上面说：")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("go")]),t._v(" "),n("p",[t._v("在解决问题之前需要了解关于go是如何实现connection的一些背景小知识：")]),t._v(" "),n("p",[t._v("有两个协程，一个用于读，一个用于写（就是"),n("code",[t._v("readLoop")]),t._v("和"),n("code",[t._v("writeLoop")]),t._v("）。在大多数情况下，"),n("code",[t._v("readLoop")]),t._v("会检测"),n("code",[t._v("socket")]),t._v("是否关闭，并适时关闭"),n("code",[t._v("connection")]),t._v("。如果一个新请求在"),n("code",[t._v("readLoop")]),t._v("检测到关闭之前就到来了，那么就会产生"),n("code",[t._v("EOF")]),t._v("错误并中断执行，而不是去关闭前一个请求。")]),t._v(" "),n("p",[t._v("这里也是如此，我执行时建立一个新的连接，这段程序执行完成后退出，再次打开执行时服务器并不知道我已经关闭了连接，所以提示连接被重置；如果我不退出程序而使用for循环多次发送时，旧连接未关闭，新连接却到来，会报"),n("code",[t._v("EOF")]),t._v("。")])]),t._v(" "),n("p",[t._v("提出的解决方案是对 req 增加属性设置：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("req.Close = true\n")])])]),n("p",[t._v("它会阻止连接被重用，可以有效的防止这个问题，也就是Http的短连接")]),t._v(" "),n("p",[t._v("该博主问题与我的类似，于是我写了个小例子来测试，代码如下：")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net/http"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sync"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsUrlOk")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tresponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatalf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[IsUrlOk] get url【%s】error! error is %s"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusOK "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"response.StatusCode"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsUrlOk2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\treq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"req err"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\treq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Close "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\tresponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DefaultClient"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Do")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatalf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[IsUrlOk] get url【%s】error! error is %s"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Body"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusOK "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"response.StatusCode"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StatusCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\turl "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://npm.taobao.org/mirrors/node/v14.7.0/node-v14.7.0-win-x64.zip"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// url := "https://cdn.npm.taobao.org/dist/node/v14.7.0/node-v14.7.0-win-x64.zip"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// b := IsUrlOk(url)")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// b := IsUrlOk2(url)")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// log.Println(b)")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" wg sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WaitGroup\n\tstartTime "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// b := IsUrlOk(url)")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsUrlOk2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Since")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("startTime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\ttime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("其中，"),n("code",[t._v("IsUrlOk")]),t._v("与"),n("code",[t._v("IsUrlOk2")]),t._v("的区别是前者是我旧的请求代码，后者是加了"),n("code",[t._v("Close")]),t._v("后的代码。")]),t._v(" "),n("p",[t._v("并发量设置为"),n("code",[t._v("100")]),t._v("，但依然会偶现上面的错误，尤其是在运行结束后，立即再次运行。")]),t._v(" "),n("p",[t._v("将并发量设置为"),n("code",[t._v("500")]),t._v("后，复现的概率就大大增加了。")]),t._v(" "),n("h2",{attrs:{id:"tcp握手"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcp握手"}},[t._v("#")]),t._v(" TCP握手")]),t._v(" "),n("p",[t._v("在头疼之际，找到了另一篇文章"),n("a",{attrs:{href:"http://www.coder55.com/article/6791",target:"_blank",rel:"noopener noreferrer"}},[t._v("记一次压测问题定位：connection reset by peer，TCP三次握手后服务端发送RST"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("为了方便，我把文章主要内容扒来：")]),t._v(" "),n("h3",{attrs:{id:"问题定位以及原因"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题定位以及原因"}},[t._v("#")]),t._v(" 问题定位以及原因")]),t._v(" "),n("p",[n("code",[t._v("connection reset by peer")]),t._v("的含义是往对端写数据的时候，对端提示已经关闭了连接。一般往一个已经被关闭的"),n("code",[t._v("socket")]),t._v("写会提示这个错误。但是通过log分析，服务端没有应用层面的"),n("code",[t._v("close")]),t._v("，客户端也没有应用层面的"),n("code",[t._v("write")]),t._v("。抓包发现客户端建立"),n("code",[t._v("TCP")]),t._v("完成3次握手后，服务端立刻就回了"),n("code",[t._v("RST")]),t._v("，关闭了连接。"),n("code",[t._v("RST")]),t._v("的情况见的多，这种情况着实没有遇到过。最后N次"),n("code",[t._v("baidu google")]),t._v("，终于找到答案。")]),t._v(" "),n("h3",{attrs:{id:"tcp三次握手后服务端直接rst的真相"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcp三次握手后服务端直接rst的真相"}},[t._v("#")]),t._v(" TCP三次握手后服务端直接RST的真相")]),t._v(" "),n("p",[t._v("内核中处理"),n("code",[t._v("TCP")]),t._v("连接时维护着两个队列:"),n("code",[t._v("SYN")]),t._v("队列和"),n("code",[t._v("ACCEPT")]),t._v("队列。\n服务端在建立连接过程中，内核的处理过程如下：")]),t._v(" "),n("ol",[n("li",[t._v("客户端使用"),n("code",[t._v("connect")]),t._v("调用向服务端发起"),n("code",[t._v("TCP")]),t._v("连接，内核将此连接信息放入"),n("code",[t._v("SYN队列")]),t._v("，返回"),n("code",[t._v("SYN-ACK")])]),t._v(" "),n("li",[t._v("服务端内核收到客户端的"),n("code",[t._v("ACK")]),t._v("后，将此连接从"),n("code",[t._v("SYN队列")]),t._v("中取出，放入"),n("code",[t._v("ACCEPT队列")])]),t._v(" "),n("li",[t._v("服务端使用"),n("code",[t._v("accept")]),t._v("调用将连接从"),n("code",[t._v("ACCEPT队列")]),t._v("中取出")])]),t._v(" "),n("p",[t._v("上述抓包说明，3次握手已经完成。\n但是应用层"),n("code",[t._v("accept")]),t._v("并没有返回，说明问题出在"),n("code",[t._v("ACCEPT队列")]),t._v("中。")]),t._v(" "),n("p",[t._v("那么什么情况下，内核准确的说应该是"),n("code",[t._v("TCP协议栈")]),t._v("会在三次握手完成后发"),n("code",[t._v("RST")]),t._v("呢？\n原因就是"),n("code",[t._v("ACCEPT队列")]),t._v("满了，上述（2）中，服务端内核收到客户端的"),n("code",[t._v("ACK")]),t._v("后将连接放入"),n("code",[t._v("ACCEPT队列")]),t._v("失败，就有可能回"),n("code",[t._v("RST")]),t._v("拒绝连接。")]),t._v(" "),n("p",[t._v("进一步来看"),n("code",[t._v("Linux协议栈")]),t._v("的一些逻辑：")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("Linux协议栈的一些逻辑")]),t._v(" "),n("p",[n("code",[t._v("SYN队列")]),t._v("和"),n("code",[t._v("ACCEPT队列")]),t._v("的长度是有限制的，"),n("code",[t._v("SYN队列")]),t._v("长度由内核参数"),n("code",[t._v("tcp_max_syn_backlog")]),t._v("决定，"),n("code",[t._v("ACCEPT队列")]),t._v("长度可以在调用"),n("code",[t._v("listen(backlog)")]),t._v("通过"),n("code",[t._v("backlog")]),t._v("，但总最大值受到内核参数"),n("code",[t._v("somaxconn")]),t._v("("),n("code",[t._v("/proc/sys/net/core/somaxconn")]),t._v(")限制。")]),t._v(" "),n("p",[t._v("若"),n("code",[t._v("SYN队列")]),t._v("满了，新的"),n("code",[t._v("SYN包")]),t._v("会被直接丢弃。\n若"),n("code",[t._v("ACCEPT队列")]),t._v("满了，建立成功的连接不会从"),n("code",[t._v("SYN队列")]),t._v("中移除，同时也不会拒绝新的连接，这会加剧"),n("code",[t._v("SYN队列")]),t._v("的增长，最终会导致"),n("code",[t._v("SYN队列")]),t._v("的溢出。")]),t._v(" "),n("p",[t._v("当"),n("code",[t._v("ACCEPT队列")]),t._v("溢出之后，只要打开"),n("code",[t._v("tcp_abort_on_flow")]),t._v("内核参数(默认为"),n("code",[t._v("0")]),t._v("，关闭)，建立连接后直接回"),n("code",[t._v("RST")]),t._v("，拒绝连接(可以通过"),n("code",[t._v("/proc/net/netstat")]),t._v("中"),n("code",[t._v("ListenOverflows")]),t._v("和"),n("code",[t._v("ListenDrops")]),t._v("查看拒绝的数目)。")])]),t._v(" "),n("p",[t._v("所以真相找到了：就是"),n("code",[t._v("ACCEPT队列")]),t._v("溢出了导致"),n("code",[t._v("TCP")]),t._v("三次握手后服务端发送"),n("code",[t._v("RST")]),t._v("。")]),t._v(" "),n("p",[t._v("我压测的时候起"),n("code",[t._v("500")]),t._v("个"),n("code",[t._v("goruntine")]),t._v("，同时跟服务端建立"),n("code",[t._v("HTTP")]),t._v("连接，可能导致了服务端的"),n("code",[t._v("ACCEPT队列")]),t._v("溢出。这里之所以用可能，是因为并没有找到证据，只是理论上分析。")]),t._v(" "),n("p",[t._v("但是验证这个问题简单：修改一下内核参数"),n("code",[t._v("somaxconn")]),t._v("。")]),t._v(" "),n("p",[t._v("果然，用以下方法修改后，"),n("code",[t._v("500")]),t._v("个也不会再报错了。")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("echo 10000 >/proc/sys/net/core/somaxconn\n")])])]),n("h2",{attrs:{id:"永久修改somaxconn"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#永久修改somaxconn"}},[t._v("#")]),t._v(" 永久修改somaxconn")]),t._v(" "),n("p",[t._v("修改"),n("code",[t._v("/proc/sys/net/core/somaxconn")]),t._v("后，重启后保存不了")]),t._v(" "),n("p",[t._v("在"),n("code",[t._v("/etc/sysctl.conf")]),t._v("中添加如下")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("net.core.somaxconn = 2048\n")])])]),n("p",[t._v("然后在终端中执行")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sysctl -p\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);